<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CutsByAK - Admin</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #fff; min-height: 100vh; }
  .container { max-width: 560px; margin: 0 auto; padding: 20px; }
  h1 { text-align: center; font-size: 1.6rem; margin-bottom: 4px; letter-spacing: 2px; }
  .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 0.85rem; }
  .section-title { font-size: 1rem; font-weight: 600; color: #ff6600; margin: 20px 0 12px; }
  input[type="password"], input[type="date"] {
    width: 100%; padding: 14px; border-radius: 10px; border: 2px solid #333;
    background: #1a1a1a; color: #fff; font-size: 1rem; margin-bottom: 12px;
  }
  input:focus { outline: none; border-color: #ff6600; }
  .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
  .btn-gold { background: #ff6600; color: #000; }
  .btn-gold:hover { background: #ff8533; }
  .btn-red { background: #8b0000; color: #fff; }
  .btn-red:hover { background: #a50000; }
  .btn-sm { width: auto; padding: 8px 16px; font-size: 0.85rem; border-radius: 8px; }
  .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-bottom: 10px; }
  .card .row { display: flex; justify-content: space-between; align-items: center; }
  .card .name { font-weight: 600; }
  .card .info { color: #999; font-size: 0.85rem; margin-top: 4px; }
  .slot-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
  .slot-item { padding: 10px 4px; border-radius: 8px; border: 2px solid #333; background: #1a1a1a; color: #fff; font-size: 0.85rem; text-align: center; cursor: pointer; transition: all 0.2s; }
  .slot-item.blocked { background: #3a1010; border-color: #8b0000; color: #ff6666; }
  .slot-item.booked { background: #1a2a1a; border-color: #2a6a2a; color: #66cc66; cursor: default; }
  .day-toggle { display: flex; gap: 10px; margin-bottom: 16px; }
  .day-toggle .btn { flex: 1; }
  .empty { text-align: center; color: #666; padding: 20px; }
  #login-screen, #admin-screen { display: none; }
  #login-screen.active, #admin-screen.active { display: block; }
</style>
</head>
<body>
<div class="container">
  <h1>CutsByAK</h1>
  <p class="subtitle">Admin Panel</p>

  <!-- Login -->
  <div id="login-screen" class="active">
    <p class="section-title">Enter PIN</p>
    <input type="password" id="pin-input" placeholder="Admin PIN" maxlength="10">
    <button class="btn btn-gold" id="login-btn">Login</button>
    <p id="login-error" style="color:#ff6666;text-align:center;margin-top:8px;display:none;">Invalid PIN</p>
  </div>

  <!-- Admin -->
  <div id="admin-screen">
    <p class="section-title">Select Date</p>
    <input type="date" id="admin-date">

    <!-- Day block toggle -->
    <div class="day-toggle" id="day-toggle" style="display:none;">
      <button class="btn btn-red btn-sm" id="block-day-btn">Block Entire Day</button>
      <button class="btn btn-gold btn-sm" id="unblock-day-btn" style="display:none;">Unblock Day</button>
    </div>

    <!-- Appointments -->
    <p class="section-title">Appointments</p>
    <div id="appointments-list"><div class="empty">Select a date above</div></div>

    <!-- Slot Management -->
    <p class="section-title">Slot Management <span style="font-size:0.75rem;color:#888;font-weight:normal;">(tap to toggle block)</span></p>
    <div id="slots-grid" class="slot-grid"></div>
  </div>
</div>

<script>
let pin = sessionStorage.getItem('admin_pin') || '';
const API = '';

function headers() {
  return { 'Content-Type': 'application/json', 'X-Admin-Pin': pin };
}

// Auto-login if PIN stored
if (pin) tryLogin(pin);

document.getElementById('login-btn').addEventListener('click', () => {
  const val = document.getElementById('pin-input').value.trim();
  if (val) tryLogin(val);
});
document.getElementById('pin-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('login-btn').click();
});

async function tryLogin(testPin) {
  // Test PIN by making an API call
  const today = new Date().toISOString().split('T')[0];
  const res = await fetch(API + `/api/admin/appointments?date=${today}`, {
    headers: { 'X-Admin-Pin': testPin },
  });
  if (res.ok) {
    pin = testPin;
    sessionStorage.setItem('admin_pin', pin);
    document.getElementById('login-screen').classList.remove('active');
    document.getElementById('admin-screen').classList.add('active');
  } else {
    document.getElementById('login-error').style.display = 'block';
    sessionStorage.removeItem('admin_pin');
  }
}

// Date picker
const adminDate = document.getElementById('admin-date');
adminDate.addEventListener('change', () => {
  if (adminDate.value) loadDay(adminDate.value);
});

async function loadDay(dateStr) {
  await Promise.all([loadAppointments(dateStr), loadBlocked(dateStr)]);
}

async function loadAppointments(dateStr) {
  const res = await fetch(API + `/api/admin/appointments?date=${dateStr}`, { headers: headers() });
  const data = await res.json();
  const list = document.getElementById('appointments-list');

  if (!data.length) {
    list.innerHTML = '<div class="empty">No appointments for this date</div>';
    return;
  }

  list.innerHTML = '';
  data.forEach(appt => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${appt.customer_name}</div>
          <div class="info">${appt.service_name} &mdash; ${appt.time} &bull; ${appt.customer_phone}</div>
        </div>
        <button class="btn btn-red btn-sm cancel-btn" data-id="${appt.id}">Cancel</button>
      </div>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Cancel this appointment?')) return;
      const res = await fetch(API + `/api/admin/appointments/${btn.dataset.id}`, {
        method: 'DELETE', headers: headers(),
      });
      if (res.ok) loadDay(adminDate.value);
    });
  });
}

async function loadBlocked(dateStr) {
  const res = await fetch(API + `/api/admin/blocked/${dateStr}`, { headers: headers() });
  const data = await res.json();

  // Day toggle
  const toggle = document.getElementById('day-toggle');
  toggle.style.display = 'flex';
  const blockBtn = document.getElementById('block-day-btn');
  const unblockBtn = document.getElementById('unblock-day-btn');

  if (data.day_blocked) {
    blockBtn.style.display = 'none';
    unblockBtn.style.display = 'block';
  } else {
    blockBtn.style.display = 'block';
    unblockBtn.style.display = 'none';
  }

  blockBtn.onclick = async () => {
    await fetch(API + '/api/admin/block-day', {
      method: 'POST', headers: headers(),
      body: JSON.stringify({ date: dateStr }),
    });
    loadDay(dateStr);
  };
  unblockBtn.onclick = async () => {
    await fetch(API + '/api/admin/unblock-day', {
      method: 'DELETE', headers: headers(),
      body: JSON.stringify({ date: dateStr }),
    });
    loadDay(dateStr);
  };

  // Slots grid
  const grid = document.getElementById('slots-grid');
  grid.innerHTML = '';
  const blockedSet = new Set(data.blocked_slots);

  data.all_slots.forEach(slot => {
    const item = document.createElement('div');
    item.className = 'slot-item' + (blockedSet.has(slot) ? ' blocked' : '');
    item.textContent = slot;
    if (data.day_blocked) {
      item.className = 'slot-item blocked';
      return grid.appendChild(item);
    }
    item.onclick = async () => {
      if (blockedSet.has(slot)) {
        await fetch(API + '/api/admin/unblock-slot', {
          method: 'DELETE', headers: headers(),
          body: JSON.stringify({ date: dateStr, time: slot }),
        });
      } else {
        await fetch(API + '/api/admin/block-slot', {
          method: 'POST', headers: headers(),
          body: JSON.stringify({ date: dateStr, time: slot }),
        });
      }
      loadDay(dateStr);
    };
    grid.appendChild(item);
  });
}
</script>
</body>
</html>
